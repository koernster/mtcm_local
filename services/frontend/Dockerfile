# Use an official Node.js runtime as a parent image
FROM node:18

# Set the working directory inside the container
WORKDIR /app

# Define build args for React env vars
ARG REACT_APP_KEYCLOAK_API_BASE_URL
ARG REACT_APP_KEYCLOAK_REALM
ARG REACT_APP_KEYCLOAK_CLIENT_ID
ARG REACT_APP_KEYCLOAK_REDIRECT_URL
ARG REACT_APP_KEYCLOAK_REFRESH_TOKEN_INTERVAL
ARG REACT_APP_HASURA_ADMIN_SECRET
ARG REACT_APP_MTCM_DB_API_BASE_URL
ARG REACT_APP_HUBSPOT_API_URL
ARG REACT_APP_HUBSPOT_API_TOKEN
ARG REACT_APP_EXCEL_EXTRACTOR_API_URL
ARG REACT_APP_MAINTENANCE_MODE
ARG REACT_APP_CURRENCY_FORMAT
ARG REACT_APP_DATE_FORMAT
ARG REACT_APP_PERCENTAGE_FORMAT
ARG REACT_APP_DEFAULT_LOCALE
ARG REACT_APP_DEFAULT_CURRENCY

# Set them as env vars for the build
ENV REACT_APP_KEYCLOAK_API_BASE_URL=$REACT_APP_KEYCLOAK_API_BASE_URL
ENV REACT_APP_KEYCLOAK_REALM=$REACT_APP_KEYCLOAK_REALM
ENV REACT_APP_KEYCLOAK_CLIENT_ID=$REACT_APP_KEYCLOAK_CLIENT_ID
ENV REACT_APP_KEYCLOAK_REDIRECT_URL=$REACT_APP_KEYCLOAK_REDIRECT_URL
ENV REACT_APP_KEYCLOAK_REFRESH_TOKEN_INTERVAL=$REACT_APP_KEYCLOAK_REFRESH_TOKEN_INTERVAL
ENV REACT_APP_HASURA_ADMIN_SECRET=$REACT_APP_HASURA_ADMIN_SECRET
ENV REACT_APP_MTCM_DB_API_BASE_URL=$REACT_APP_MTCM_DB_API_BASE_URL
ENV REACT_APP_HUBSPOT_API_URL=$REACT_APP_HUBSPOT_API_URL
ENV REACT_APP_HUBSPOT_API_TOKEN=$REACT_APP_HUBSPOT_API_TOKEN
ENV REACT_APP_EXCEL_EXTRACTOR_API_URL=$REACT_APP_EXCEL_EXTRACTOR_API_URL
ENV REACT_APP_MAINTENANCE_MODE=$REACT_APP_MAINTENANCE_MODE
ENV REACT_APP_CURRENCY_FORMAT=$REACT_APP_CURRENCY_FORMAT
ENV REACT_APP_DATE_FORMAT=$REACT_APP_DATE_FORMAT
ENV REACT_APP_PERCENTAGE_FORMAT=$REACT_APP_PERCENTAGE_FORMAT
ENV REACT_APP_DEFAULT_LOCALE=$REACT_APP_DEFAULT_LOCALE
ENV REACT_APP_DEFAULT_CURRENCY=$REACT_APP_DEFAULT_CURRENCY

# Copy package.json and package-lock.json to the working directory
COPY ./package.json ./package-lock.json ./

# Install dependencies
RUN npm install

# Copy the rest of the application's code
COPY . .

# Build the React app
RUN npm run build

# Serve the build directory with a lightweight web server
RUN npm install -g serve

# Expose the port the app runs on
EXPOSE 5000

# Define the command to run the app
# Listen on 0.0.0.0 to accept connections from Docker network
CMD ["serve", "-s", "build", "-l", "tcp://0.0.0.0:5000"]

